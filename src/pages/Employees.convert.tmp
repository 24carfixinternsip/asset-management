import { useState, useEffect, useMemo } from "react";
import { useSearchParams } from "react-router-dom";
import { MainLayout } from "@/components/layout/MainLayout";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Skeleton } from "@/components/ui/skeleton";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { 
  Command, 
  CommandEmpty, 
  CommandGroup, 
  CommandInput, 
  CommandItem, 
  CommandList, 
  CommandSeparator 
} from "@/components/ui/command";
import { 
  Plus, Trash2, Users, Camera, Mail, Phone, MapPin, 
  Pencil, Eye, Package, Search, Filter, X, Check, Upload, Building2,
  CalendarClock, CalendarCheck2, ZoomIn, CheckCircle2
} from "lucide-react";
import { useEmployees, useCreateEmployee, useDeleteEmployee, useDepartments, useUpdateEmployee, useLocations, Employee } from "@/hooks/useMasterData";
import { useEmployeeTransactions, useReturnTransaction, Transaction } from "@/hooks/useTransactions";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import { StatusBadge } from "@/components/ui/status-badge";
import { ReturnDialog } from "@/components/transactions/TransactionDialogs";
import { format } from "date-fns";
import { th } from "date-fns/locale";
import { cn } from "@/lib/utils";
import { ImportEmployeeDialog } from "@/components/employees/ImportEmployeeDialog";

export default function Employees() {
  // Setup URL Params
  const [searchParams, setSearchParams] = useSearchParams();

  const { data: employeesQueryData, isLoading, refetch: refetchEmployees } = useEmployees();
  const { data: departments } = useDepartments();
  const { data: locations } = useLocations();

  const createEmployee = useCreateEmployee();
  const updateEmployee = useUpdateEmployee();
  const deleteEmployee = useDeleteEmployee();
  
  // --- Initialize States from URL ---
  const [searchTerm, setSearchTerm] = useState(searchParams.get("q") || "");
  
  // แ�>ล�? dept=1,2,3 �^าก URL กลั�s�?�>�?�T Array
  const [filterDeptIds, setFilterDeptIds] = useState<string[]>(() => {
    const deptParam = searchParams.get("dept");
    return deptParam ? deptParam.split(",") : [];
  });

  const [filterLocationId, setFilterLocationId] = useState<string>(() => {
    const locParam = searchParams.get("loc");
    return locParam || "all";
  });

  // Modal States from URL
  const modalParam = searchParams.get("modal");
  const idParam = searchParams.get("id");

  const [isImportDialogOpen, setIsImportDialogOpen] = useState(modalParam === "import");
  const [isDialogOpen, setIsDialogOpen] = useState(modalParam === "add" || modalParam === "edit");
  const [isViewDialogOpen, setIsViewDialogOpen] = useState(modalParam === "view");
  const [isEditing, setIsEditing] = useState(modalParam === "edit");
  const [selectedEmployeeId, setSelectedEmployeeId] = useState<string | null>(idParam);

  const [isUploading, setIsUploading] = useState(false);
  const returnTransaction = useReturnTransaction();
  const [returnDialog, setReturnDialog] = useState<{ open: boolean; tx: Transaction | null }>({
    open: false,
    tx: null,
  });
  const [historySearch, setHistorySearch] = useState("");
  const [historyStatus, setHistoryStatus] = useState<"all" | Transaction["status"]>("all");
  const [imagePreview, setImagePreview] = useState({ open: false, url: "", name: "" });
  
  // Transaction Data for View Mode
  const { data: empTransactions, isLoading: isTransLoading } = useEmployeeTransactions(selectedEmployeeId);

  // --- Form Data ---
  const [formData, setFormData] = useState({
    emp_code: "",
    name: "",
    nickname: "",
    gender: "",
    email: "",
    tel: "",
    location_id: "",
    department_id: "",
    image_url: "",
  });
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [deletingEmployeeId, setDeletingEmployeeId] = useState<string | null>(null);

  useEffect(() => {
    setEmployees(employeesQueryData ?? []);
  }, [employeesQueryData]);

  // Sync State -> URL
  useEffect(() => {
    const params = new URLSearchParams(searchParams);

    // Search
    if (searchTerm) params.set("q", searchTerm);
    else params.delete("q");

    // Dept Filter
    if (filterDeptIds.length > 0) params.set("dept", filterDeptIds.join(","));
    else params.delete("dept");

    // Location Filter
    if (filterLocationId && filterLocationId !== "all") params.set("loc", filterLocationId);
    else params.delete("loc");

    // Modals & ID
    if (isImportDialogOpen) {
      params.set("modal", "import");
      params.delete("id");
    } else if (isViewDialogOpen && selectedEmployeeId) {
      params.set("modal", "view");
      params.set("id", selectedEmployeeId);
    } else if (isDialogOpen) {
      params.set("modal", isEditing ? "edit" : "add");
      if (isEditing && selectedEmployeeId) {
        params.set("id", selectedEmployeeId);
      } else {
        params.delete("id");
      }
    } else {
      params.delete("modal");
      params.delete("id");
    }

    setSearchParams(params, { replace: true });
  }, [searchTerm, filterDeptIds, filterLocationId, isImportDialogOpen, isDialogOpen, isViewDialogOpen, isEditing, selectedEmployeeId, setSearchParams]);

  // Auto-Fill Form when refreshing on Edit Mode
  // �?มื�^อ�,หล�"�,�?อมูล�z�Tัก�?า�T�?สร�?�^ และ URL �sอกว�^า�?�>�?�T�,หม�" Edit �fห�?�?�.ิม�,�?อมูลล�? Form
  useEffect(() => {
    if (employees && isEditing && selectedEmployeeId && isDialogOpen) {
      // �?�S�?�"ว�^า Form ว�^า�?อยู�^�"หม (�>�?อ�?กั�Tการ�-ั�s�,�?อมูล�-ี�^กำลั�?�zิม�z�O)
      if (!formData.name) {
        const emp = employees.find(e => e.id === selectedEmployeeId);
        if (emp) {
          setFormData({
            emp_code: emp.emp_code,
            name: emp.name,
            nickname: emp.nickname || "",
            gender: emp.gender || "",
            email: emp.email || "",
            tel: emp.tel || "",
            location_id: emp.location_id || "",
            department_id: emp.department_id || "",
            image_url: emp.image_url || "",
          });
        }
      }
    }
  }, [employees, isEditing, selectedEmployeeId, isDialogOpen]);

  useEffect(() => {
    if (!isViewDialogOpen) {
      setHistorySearch("");
      setHistoryStatus("all");
    }
  }, [isViewDialogOpen]);

  // Logic การกรอ�?�,�?อมูล
  const filteredEmployees = useMemo(() => {
    return employees.filter(emp => {
      const searchLower = searchTerm.toLowerCase();
      const matchesSearch = 
        emp.name.toLowerCase().includes(searchLower) ||
        (emp.nickname && emp.nickname.toLowerCase().includes(searchLower)) ||
        emp.emp_code.toLowerCase().includes(searchLower);

      const matchesDept = 
        filterDeptIds.length === 0 || 
        (emp.department_id && filterDeptIds.includes(emp.department_id));

      const matchesLocation =
        filterLocationId === "all" || (emp.location_id && emp.location_id === filterLocationId);

      return matchesSearch && matchesDept && matchesLocation;
    });
  }, [employees, searchTerm, filterDeptIds, filterLocationId]);

  const totalEmployees = employees.length;
  const departmentCount = departments?.length ?? 0;
  const locationCount = locations?.length ?? 0;
  const filteredCount = filteredEmployees.length;

  const selectedEmployee = useMemo(() => {
    if (!selectedEmployeeId) return null;
    return employees.find((emp) => emp.id === selectedEmployeeId) || null;
  }, [employees, selectedEmployeeId]);

  const statCards = [
    {
      label: "Total Employees",
      value: totalEmployees,
      icon: Users,
      tone: "bg-orange-100 text-orange-600",
      note: "Active profiles in system",
    },
    {
      label: "Departments",
      value: departmentCount,
      icon: Building2,
      tone: "bg-sky-100 text-sky-600",
      note: "Organization units",
    },
    {
      label: "Locations",
      value: locationCount,
      icon: MapPin,
      tone: "bg-emerald-100 text-emerald-600",
      note: "Work sites tracked",
    },
    {
      label: "Filtered Results",
      value: filteredCount,
      icon: Filter,
      tone: "bg-slate-100 text-slate-600",
      note: "Matches current filters",
    },
  ];

  const filteredTransactions = useMemo(() => {
    if (!empTransactions) return [];
    const searchLower = historySearch.toLowerCase();
    return empTransactions.filter((tx) => {
      const matchesStatus = historyStatus === "all" || tx.status === historyStatus;
      const matchesSearch =
        !searchLower ||
        tx.product_serials?.products?.name?.toLowerCase().includes(searchLower) ||
        tx.product_serials?.serial_code?.toLowerCase().includes(searchLower) ||
        tx.status?.toLowerCase().includes(searchLower);
      return matchesStatus && matchesSearch;
    });
  }, [empTransactions, historySearch, historyStatus]);

  const historyResults = filteredTransactions.length;
  const hasHistoryFilters = historySearch.trim().length > 0 || historyStatus !== "all";

  // Reset Form
  const resetForm = () => {
    setFormData({ 
      emp_code: "", name: "", nickname: "", gender: "", 
      email: "", tel: "", location_id: "", department_id: "", image_url: "" 
    });
    setSelectedEmployeeId(null);
    setIsEditing(false);
  };

  // Handlers
  const handleOpenAdd = () => {
    resetForm();
    setIsEditing(false);
    setIsDialogOpen(true);
  };

  const handleOpenEdit = (emp: Employee) => {
    setFormData({
      emp_code: emp.emp_code,
      name: emp.name,
      nickname: emp.nickname || "",
      gender: emp.gender || "",
      email: emp.email || "",
      tel: emp.tel || "",
      location_id: emp.location_id || "",
      department_id: emp.department_id || "",
      image_url: emp.image_url || "",
    });
    setSelectedEmployeeId(emp.id);
    setIsEditing(true);
    setIsDialogOpen(true);
  };

  const handleOpenView = (id: string) => {
    setSelectedEmployeeId(id);
    setIsViewDialogOpen(true);
  };

  const handleCloseDialog = () => {
    setIsDialogOpen(false);
    // รอ animation �^�sแล�?ว�"�^อย�?�"ลียร�O form ก�?�"�"�? หรือ�?�"ลียร�O�?ลยก�?�"�"�?
    setTimeout(() => resetForm(), 300);
  };

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setIsUploading(true);
    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `employees/${Date.now()}.${fileExt}`;

      const { error: uploadError } = await supabase.storage
        .from('asset-images')
        .upload(fileName, file);

      if (uploadError) throw uploadError;

      const { data: { publicUrl } } = supabase.storage
        .from('asset-images')
        .getPublicUrl(fileName);

      setFormData(prev => ({ ...prev, image_url: publicUrl }));
      toast.success('อั�>�,หล�"รู�>ภา�zสำ�?ร�?�^');
    } catch (error) {
      console.error(error);
      toast.error('อั�>�,หล�"รู�>ภา�z�"ม�^สำ�?ร�?�^');
    } finally {
      setIsUploading(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    const commonData = {
      emp_code: formData.emp_code ? formData.emp_code : null, 
      name: formData.name,
      nickname: formData.nickname || null,
      gender: formData.gender || null,
      email: formData.email || null,
      tel: formData.tel || null,
      location_id: formData.location_id || null,
      department_id: formData.department_id || null,
      image_url: formData.image_url || null,
    };

    try {
      if (isEditing && selectedEmployeeId) {
        await updateEmployee.mutateAsync({
          id: selectedEmployeeId,
          ...commonData //
        });
      } else {
        await createEmployee.mutateAsync(commonData);
      }
      setIsDialogOpen(false);
      resetForm();
    } catch (error) {
      // Error handled in hook
    }
  };

  const handleDeleteEmployee = async (employeeId: string, employeeName: string) => {
    if (deletingEmployeeId) return;

    const isConfirmed = window.confirm(`�.�?อ�?การล�s�z�Tัก�?า�T ${employeeName} �f�S�^หรือ�"ม�^?`);
    if (!isConfirmed) return;

    try {
      setDeletingEmployeeId(employeeId);
      await deleteEmployee.mutateAsync(employeeId);

      // Keep the rendered list in sync immediately; remove by id from the source state.
      setEmployees((prevEmployees) =>
        prevEmployees.filter((employee) => employee.id !== employeeId),
      );

      if (selectedEmployeeId === employeeId) {
        setIsViewDialogOpen(false);
        setSelectedEmployeeId(null);
      }

      // Revalidate from DB after optimistic local update to avoid stale UI.
      await refetchEmployees();
    } catch (error) {
      console.error("Delete employee handler failed:", error);
    } finally {
      setDeletingEmployeeId(null);
    }
  };

  const handleReturnConfirm = async (condition: string, note: string) => {
    if (!returnDialog.tx) return;
    await returnTransaction.mutateAsync({
      transactionId: returnDialog.tx.id,
      condition,
      note,
    });
    setReturnDialog({ open: false, tx: null });
  };

  const openImagePreview = (url: string | null | undefined, name?: string | null) => {
    if (!url) return;
    setImagePreview({ open: true, url, name: name || "Asset image" });
  };

  const formatDate = (dateString: string | null) => {
    if (!dateString) return '-';
    return format(new Date(dateString), 'd MMM yy HH:mm', { locale: th });
  };

  return (
    <MainLayout title="�^ั�"การ�z�Tัก�?า�T">
      <div className="relative">
        <div
          aria-hidden
          className="pointer-events-none absolute -top-24 right-0 h-72 w-72 rounded-full bg-orange-200/40 blur-3xl"
        />
        <div
          aria-hidden
          className="pointer-events-none absolute top-24 -left-20 h-80 w-80 rounded-full bg-sky-200/40 blur-3xl"
        />
        <div className="relative space-y-6">
          {/* Hero */}
          <div className="glass rounded-2xl border border-white/60 p-5 sm:p-6">
            <div className="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
              <div className="space-y-2">
                <div className="inline-flex items-center gap-2 rounded-full border border-orange-200/70 bg-orange-50 px-3 py-1 text-xs font-medium text-orange-600">
                  <Users className="h-3.5 w-3.5" />
                  Employee Asset Hub
                </div>
                <h2 className="text-2xl font-semibold tracking-tight sm:text-3xl">
                  Manage employee profiles and asset history
                </h2>
                <p className="text-sm text-muted-foreground">
                  �^ั�"การ�,�?อมูล�z�Tัก�?า�T รายละ�?อีย�"การ�.ิ�"�.�^อ และ�>ระวั�.ิการ�?�sิกอุ�>กร�"�O
                </p>
              </div>
              <div className="flex flex-wrap gap-2">
                <Button
                  variant="outline"
                  className="h-10 gap-2 rounded-full bg-white/80 transition active:scale-95"
                  onClick={() => setIsImportDialogOpen(true)}
                >
                  <Upload className="h-4 w-4" />
                  Import CSV
                </Button>
                <Button className="h-10 gap-2 rounded-full px-5 shadow-sm transition active:scale-95" onClick={handleOpenAdd}>
                  <Plus className="h-4 w-4" />
                  �?�zิ�^ม�z�Tัก�?า�T
                </Button>
              </div>
            </div>
            <div className="mt-5 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
              {statCards.map((stat) => (
                <div
                  key={stat.label}
                  className="rounded-xl border border-border/60 bg-card/80 p-4 shadow-sm"
                >
                  <div className="flex items-center justify-between">
                    <span className="text-xs font-medium text-muted-foreground">{stat.label}</span>
                    <div className={cn("flex h-9 w-9 items-center justify-center rounded-lg", stat.tone)}>
                      <stat.icon className="h-4 w-4" />
                    </div>
                  </div>
                  <div className="mt-2 text-2xl font-semibold">{stat.value.toLocaleString()}</div>
                  <p className="text-xs text-muted-foreground">{stat.note}</p>
                </div>
              ))}
            </div>
          </div>

        {/* Search & Filter Bar */}
        <Card className="border border-border/60 bg-card/80 shadow-sm">
          <CardContent className="p-4 sm:p-5">
            <div className="flex flex-col gap-4 lg:flex-row lg:items-end">
              {/* Search Input */}
              <div className="flex-1 space-y-2">
                <Label className="text-xs font-medium text-muted-foreground">�"�?�Tหา</Label>
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
                  <Input
                    placeholder="�"�?�Tหา�Sื�^อ, �Sื�^อ�?ล�^�T, หรือรหัส�z�Tัก�?า�T..."
                    className="pl-9 bg-background/70 shadow-sm"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                  />
                  {searchTerm && (
                    <button
                      onClick={() => setSearchTerm("")}
                      className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground"
                      aria-label="Clear search"
                    >
                      <X className="h-3 w-3" />
                    </button>
                  )}
                </div>
              </div>

              {/* Department Filter (Multi-select) */}
              <div className="w-full lg:w-[260px] space-y-2">
                <Label className="text-xs font-medium text-muted-foreground">แ�o�Tก</Label>
                <Popover>
                  <PopoverTrigger asChild>
                    <Button
                      variant="outline"
                      className="w-full justify-start border-dashed h-10 bg-white/80"
                    >
                      <Filter className="mr-2 h-4 w-4" />
                      แ�o�Tก
                      {filterDeptIds.length > 0 && (
                        <>
                          <Separator orientation="vertical" className="mx-2 h-4" />
                          <Badge
                            variant="secondary"
                            className="rounded-sm px-1 font-normal lg:hidden"
                          >
                            {filterDeptIds.length}
                          </Badge>
                          <div className="hidden space-x-1 lg:flex">
                            {filterDeptIds.length > 2 ? (
                              <Badge
                                variant="secondary"
                                className="rounded-sm px-1 font-normal"
                              >
                                {filterDeptIds.length} รายการ
                              </Badge>
                            ) : (
                              departments
                                ?.filter((dept) => filterDeptIds.includes(dept.id))
                                .map((dept) => (
                                  <Badge
                                    variant="secondary"
                                    key={dept.id}
                                    className="rounded-sm px-1 font-normal"
                                  >
                                    {dept.name}
                                  </Badge>
                                ))
                            )}
                          </div>
                        </>
                      )}
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className="w-[250px] p-0" align="start">
                    <Command>
                      <CommandInput placeholder="�"�?�Tหาแ�o�Tก..." />
                      <CommandList>
                        <CommandEmpty>�"ม�^�z�sแ�o�Tก</CommandEmpty>
                        <CommandGroup>
                          {departments?.map((dept) => {
                            const isSelected = filterDeptIds.includes(dept.id);
                            return (
                              <CommandItem
                                key={dept.id}
                                onSelect={() => {
                                  if (isSelected) {
                                    setFilterDeptIds(filterDeptIds.filter((id) => id !== dept.id));
                                  } else {
                                    setFilterDeptIds([...filterDeptIds, dept.id]);
                                  }
                                }}
                              >
                                <div
                                  className={cn(
                                    "mr-2 flex h-4 w-4 items-center justify-center rounded-sm border border-primary",
                                    isSelected
                                      ? "bg-primary text-primary-foreground"
                                      : "opacity-50 [&_svg]:invisible"
                                  )}
                                >
                                  <Check className={cn("h-4 w-4")} />
                                </div>
                                <span>{dept.name}</span>
                              </CommandItem>
                            );
                          })}
                        </CommandGroup>
                        {filterDeptIds.length > 0 && (
                          <>
                            <CommandSeparator />
                            <CommandGroup>
                              <CommandItem
                                onSelect={() => setFilterDeptIds([])}
                                className="justify-center text-center cursor-pointer"
                              >
                                ล�?า�?�.ัวกรอ�?
                              </CommandItem>
                            </CommandGroup>
                          </>
                        )}
                      </CommandList>
                    </Command>
                  </PopoverContent>
                </Popover>
              </div>

              <div className="w-full lg:w-[220px] space-y-2">
                <Label className="text-xs font-medium text-muted-foreground">ส�-า�T�-ี�^�-ำ�?า�T</Label>
                <Select value={filterLocationId} onValueChange={setFilterLocationId}>
                  <SelectTrigger className="h-10 bg-white/80">
                    <SelectValue placeholder="�-ุกส�-า�T�-ี�^" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">�-ุกส�-า�T�-ี�^</SelectItem>
                    {locations?.map((loc) => (
                      <SelectItem key={loc.id} value={loc.id}>
                        {loc.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="flex flex-wrap gap-2">
                {(searchTerm || filterDeptIds.length > 0 || filterLocationId !== "all") && (
                  <Button
                    variant="ghost"
                    className="h-10 gap-2 rounded-full text-muted-foreground hover:text-foreground"
                    onClick={() => {
                      setSearchTerm("");
                      setFilterDeptIds([]);
                      setFilterLocationId("all");
                    }}
                  >
                    <X className="h-4 w-4" />
                    ล�?า�?�.ัวกรอ�?
                  </Button>
                )}
              </div>
            </div>

            <Separator className="my-4" />
            <div className="flex flex-wrap items-center gap-2 text-xs text-muted-foreground">
              <Badge variant="secondary" className="rounded-md px-2 py-1">
                Showing {filteredCount.toLocaleString()} / {totalEmployees.toLocaleString()}
              </Badge>
              {searchTerm && (
                <Badge variant="secondary" className="rounded-md px-2 py-1">
                  �"ำ�"�?�Tหา: {searchTerm}
                </Badge>
              )}
              {filterDeptIds.length > 0 && (
                <Badge variant="secondary" className="rounded-md px-2 py-1">
                  แ�o�Tก: {filterDeptIds.length}
                </Badge>
              )}
              {filterLocationId !== "all" && (
                <Badge variant="secondary" className="rounded-md px-2 py-1">
                  ส�-า�T�-ี�^: {locations?.find((loc) => loc.id === filterLocationId)?.name || "-"}
                </Badge>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Employee List Table */}
        <Card className="border border-border/60 bg-card/90 shadow-sm">
          <CardContent className="p-0">
            <div className="flex flex-col gap-2 border-b border-border/60 px-5 py-4 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h3 className="text-base font-semibold">ราย�Sื�^อ�z�Tัก�?า�T</h3>
                <p className="text-xs text-muted-foreground">
                  �"ู�,�?อมูล�.ิ�"�.�^อ แ�o�Tก และ�>ระวั�.ิการ�f�S�?�?า�T�-รั�zย�Oสิ�T�"�"�?อย�^า�?รว�"�?ร�?ว
                </p>
              </div>
              <div className="flex items-center gap-2 text-xs text-muted-foreground">
                <span className="rounded-full bg-muted px-2 py-1">
                  {filteredCount.toLocaleString()} results
                </span>
              </div>
            </div>
            {isLoading ? (
              <div className="p-4 space-y-3">
                {Array.from({ length: 10 }).map((_, i) => (
                  <Skeleton key={i} className="h-12 w-full" />
                ))}
              </div>
            ) : filteredEmployees && filteredEmployees.length > 0 ? (
              <div className="max-h-[520px] overflow-auto">
                <Table>
                  <TableHeader className="sticky top-0 z-10 bg-muted/70 backdrop-blur">
                    <TableRow>
                      <TableHead className="w-[80px] text-xs font-semibold uppercase tracking-wider text-muted-foreground">
                        รู�>
                      </TableHead>
                      <TableHead className="text-xs font-semibold uppercase tracking-wider text-muted-foreground">
                        รหัส / �Sื�^อ
                      </TableHead>
                      <TableHead className="text-xs font-semibold uppercase tracking-wider text-muted-foreground">
                        �,�?อมูลส�^ว�T�.ัว
                      </TableHead>
                      <TableHead className="text-xs font-semibold uppercase tracking-wider text-muted-foreground">
                        การ�.ิ�"�.�^อ
                      </TableHead>
                      <TableHead className="text-xs font-semibold uppercase tracking-wider text-muted-foreground">
                        �.ำแห�T�^�?�?า�T
                      </TableHead>
                      <TableHead className="text-right text-xs font-semibold uppercase tracking-wider text-muted-foreground">
                        �^ั�"การ
                      </TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {filteredEmployees.map((emp) => (
                      <TableRow key={emp.id} className="hover:bg-muted/30">
                        <TableCell className="py-4">
                          <button
                            type="button"
                            onClick={() => openImagePreview(emp.image_url, emp.name)}
                            className={cn(
                              "group relative rounded-full",
                              emp.image_url ? "cursor-pointer" : "cursor-default"
                            )}
                            aria-label="View employee image"
                            disabled={!emp.image_url}
                          >
                            <Avatar className="h-10 w-10 border transition group-hover:shadow-sm">
                              <AvatarImage
                                src={emp.image_url || undefined}
                                alt={emp.name}
                                className="object-cover"
                              />
                              <AvatarFallback>{emp.name.substring(0, 2).toUpperCase()}</AvatarFallback>
                            </Avatar>
                            {emp.image_url && (
                              <span className="pointer-events-none absolute -bottom-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-white text-slate-600 shadow-sm">
                                <ZoomIn className="h-3 w-3" />
                              </span>
                            )}
                          </button>
                        </TableCell>
                        <TableCell className="py-4">
                          <div className="flex flex-col">
                            <span className="font-mono text-xs text-muted-foreground">
                              {emp.emp_code || "-"}
                            </span>
                            <span className="font-semibold text-foreground">{emp.name}</span>
                          </div>
                        </TableCell>
                        <TableCell className="py-4">
                          <div className="flex flex-wrap items-center gap-2 text-xs">
                            {emp.nickname && (
                              <Badge variant="secondary" className="rounded-full px-2">
                                {emp.nickname}
                              </Badge>
                            )}
                            <span className="rounded-full border border-border/70 px-2 py-0.5 text-muted-foreground">
                              {emp.gender || "-"}
                            </span>
                          </div>
                        </TableCell>
                        <TableCell className="py-4">
                          <div className="flex flex-col gap-1 text-sm">
                            {emp.email && (
                              <div className="flex items-center gap-2 text-muted-foreground">
                                <Mail className="h-3.5 w-3.5" />
                                <span className="font-medium text-foreground">{emp.email}</span>
                              </div>
                            )}
                            {emp.tel && (
                              <div className="flex items-center gap-2 text-muted-foreground">
                                <Phone className="h-3.5 w-3.5" />
                                <span className="font-medium text-foreground">{emp.tel}</span>
                              </div>
                            )}
                          </div>
                        </TableCell>
                        <TableCell className="py-4">
                          <div className="flex flex-col gap-2 text-sm">
                            <Badge variant="secondary" className="w-fit rounded-full px-2">
                              {emp.departments?.name || "-"}
                            </Badge>
                            {emp.locations?.name && (
                              <div className="flex items-center gap-2 text-xs text-muted-foreground">
                                <MapPin className="h-3.5 w-3.5" />
                                {emp.locations.name}
                              </div>
                            )}
                          </div>
                        </TableCell>
                        <TableCell className="py-4 text-right">
                          <TooltipProvider>
                            <div className="flex justify-end gap-2">
                              <Tooltip>
                                <TooltipTrigger asChild>
                                  <Button
                                    variant="ghost"
                                    size="icon"
                                    className="h-9 w-9 rounded-full bg-sky-50 text-sky-600 hover:bg-sky-100"
                                    aria-label="�"ู�>ระวั�.ิ"
                                    onClick={() => handleOpenView(emp.id)}
                                  >
                                    <Eye className="h-4 w-4" />
                                  </Button>
                                </TooltipTrigger>
                                <TooltipContent>�"ู�>ระวั�.ิ</TooltipContent>
                              </Tooltip>
                              <Tooltip>
                                <TooltipTrigger asChild>
                                  <Button
                                    variant="ghost"
                                    size="icon"
                                    className="h-9 w-9 rounded-full bg-amber-50 text-amber-600 hover:bg-amber-100"
                                    aria-label="แก�?�"�,"
                                    onClick={() => handleOpenEdit(emp)}
                                  >
                                    <Pencil className="h-4 w-4" />
                                  </Button>
                                </TooltipTrigger>
                                <TooltipContent>แก�?�"�,</TooltipContent>
                              </Tooltip>
                              <Tooltip>
                                <TooltipTrigger asChild>
                                  <Button
                                    variant="ghost"
                                    size="icon"
                                    className="h-9 w-9 rounded-full bg-red-50 text-red-600 hover:bg-red-100"
                                    aria-label="ล�s"
                                    disabled={deletingEmployeeId !== null || deleteEmployee.isPending}
                                    onClick={() => handleDeleteEmployee(emp.id, emp.name)}
                                  >
                                    <Trash2 className="h-4 w-4" />
                                  </Button>
                                </TooltipTrigger>
                                <TooltipContent>ล�s</TooltipContent>
                              </Tooltip>
                            </div>
                          </TooltipProvider>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            ) : (
              <div className="flex flex-col items-center justify-center py-16">
                <Users className="h-16 w-16 text-muted-foreground/30 mb-4" />
                <p className="text-muted-foreground">
                  {searchTerm || filterDeptIds.length > 0
                    ? "�"ม�^�z�s�,�?อมูล�-ี�^�"�?�Tหา"
                    : "ยั�?�"ม�^มี�,�?อมูล�z�Tัก�?า�T"}
                </p>
                {searchTerm || filterDeptIds.length > 0 ? (
                  <Button
                    variant="link"
                    onClick={() => {
                      setSearchTerm("");
                      setFilterDeptIds([]);
                    }}
                  >
                    ล�?า�?�.ัวกรอ�?
                  </Button>
                ) : (
                  <Button className="mt-4" onClick={handleOpenAdd}>
                    <Plus className="h-4 w-4 mr-2" />
                    �?�zิ�^ม�z�Tัก�?า�T�"�Tแรก
                  </Button>
                )}
              </div>
            )}
          </CardContent>
        </Card>

        {/* Add/Edit Dialog */}
        <Dialog open={isDialogOpen} onOpenChange={handleCloseDialog}>
          <DialogContent className="sm:max-w-[600px] max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle>{isEditing ? 'แก�?�"�,�,�?อมูล�z�Tัก�?า�T' : '�?�zิ�^ม�z�Tัก�?า�T�fหม�^'}</DialogTitle>
            </DialogHeader>
            <form onSubmit={handleSubmit} className="space-y-6 py-4">
              
              {/* Image Upload Section */}
              <div className="flex flex-col items-center gap-4">
                <Avatar className="h-24 w-24 border-2 border-dashed border-gray-200">
                  <AvatarImage src={formData.image_url} className="object-cover" />
                  <AvatarFallback className="bg-muted">
                    <Camera className="h-8 w-8 text-muted-foreground" />
                  </AvatarFallback>
                </Avatar>
                <div className="flex items-center gap-2">
                  <Input 
                    type="file" 
                    accept="image/*" 
                    className="w-full max-w-[250px]"
                    onChange={handleImageUpload}
                    disabled={isUploading}
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Column 1 */}
                <div className="space-y-2">
                  <Label htmlFor="emp_code">รหัส�z�Tัก�?า�T (�-�?ามี)</Label>
                  <Input
                    id="emp_code"
                    placeholder="EMP-001 (�?ว�?�Tว�^า�?�"�"�?)"
                    value={formData.emp_code}
                    onChange={(e) => setFormData(prev => ({ ...prev, emp_code: e.target.value }))}
                  />
                </div>
                
                <div className="space-y-2">
                  <Label htmlFor="department">แ�o�Tก</Label>
                  <Select
                    value={formData.department_id}
                    onValueChange={(value) => setFormData(prev => ({ ...prev, department_id: value }))}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="�?ลือกแ�o�Tก" />
                    </SelectTrigger>
                    <SelectContent>
                      {departments?.map((dept) => (
                        <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="name">�Sื�^อ-�Tามสกุล <span className="text-red-500">*</span></Label>
                  <Input
                    id="name"
                    placeholder="ระ�sุ�Sื�^อ�?�.�?ม"
                    value={formData.name}
                    onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                    required
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="nickname">�Sื�^อ�?ล�^�T</Label>
                  <Input
                    id="nickname"
                    placeholder="ระ�sุ�Sื�^อ�?ล�^�T"
                    value={formData.nickname}
                    onChange={(e) => setFormData(prev => ({ ...prev, nickname: e.target.value }))}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="gender">�?�zศ</Label>
                  <Select
                    value={formData.gender}
                    onValueChange={(value) => setFormData(prev => ({ ...prev, gender: value }))}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="�?ลือก�?�zศ" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="�Sาย">�Sาย</SelectItem>
                      <SelectItem value="หญิ�?">หญิ�?</SelectItem>
                      <SelectItem value="อื�^�T�?">อื�^�T�?</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="location">ส�-า�T�-ี�^�Tั�^�?�-ำ�?า�T</Label>
                  <Select
                    value={formData.location_id}
                    onValueChange={(value) => setFormData(prev => ({ ...prev, location_id: value }))}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="ระ�sุ�Sั�?�T" />
                    </SelectTrigger>
                    <SelectContent>
                      {locations?.map((loc) => (
                        <SelectItem key={loc.id} value={loc.id}>{loc.name}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="email">Email</Label>
                  <Input
                    id="email"
                    type="email"
                    placeholder="example@company.com"
                    value={formData.email}
                    onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="tel">�?�sอร�O�,�-ร</Label>
                  <Input
                    id="tel"
                    placeholder="0xx-xxx-xxxx"
                    value={formData.tel}
                    onChange={(e) => setFormData(prev => ({ ...prev, tel: e.target.value }))}
                  />
                </div>
              </div>

              <div className="flex justify-end gap-2 pt-4 border-t">
                <Button type="button" variant="outline" onClick={handleCloseDialog}>
                  ยก�?ลิก
                </Button>
                <Button type="submit" disabled={createEmployee.isPending || updateEmployee.isPending || isUploading}>
                  {(createEmployee.isPending || updateEmployee.isPending) ? 'กำลั�?�sั�T�-ึก...' : '�sั�T�-ึก�,�?อมูล'}
                </Button>
              </div>
            </form>
          </DialogContent>
        </Dialog>

        {/* View Details Dialog */}
        <Dialog open={isViewDialogOpen} onOpenChange={setIsViewDialogOpen}>
          <DialogContent className="sm:max-w-[1040px] max-h-[92vh] overflow-hidden flex flex-col bg-white/95">
            <DialogHeader className="space-y-4 border-b pb-4">
              <div className="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                <div className="space-y-2">
                  <DialogTitle className="flex flex-wrap items-center gap-2 text-lg sm:text-xl">
                    <Package className="h-5 w-5 text-orange-500" />
                    �>ระวั�.ิการ�"รอ�s�"รอ�?�-รั�zย�Oสิ�T
                    {selectedEmployee && (
                      <span className="text-xs font-normal text-muted-foreground">- {selectedEmployee.name}</span>
                    )}
                  </DialogTitle>
                  <div className="flex flex-wrap items-center gap-2 text-xs text-muted-foreground">
                    <Badge variant="secondary" className="rounded-full px-3 py-1">
                      �z�s {historyResults.toLocaleString()} รายการ
                    </Badge>
                    {selectedEmployee?.departments?.name && (
                      <Badge variant="outline" className="rounded-full px-3 py-1">
                        {selectedEmployee.departments?.name}
                      </Badge>
                    )}
                    {selectedEmployee?.emp_code && (
                      <Badge variant="outline" className="rounded-full px-3 py-1 font-mono">
                        {selectedEmployee.emp_code}
                      </Badge>
                    )}
                  </div>
                </div>
              </div>
            </DialogHeader>

            <div className="flex-1 overflow-hidden flex flex-col gap-4">
              <div className="rounded-2xl border border-border/60 bg-slate-50/70 p-4 shadow-sm">
                <div className="grid gap-3 lg:grid-cols-[1.2fr_220px_auto] lg:items-center">
                  <div className="relative">
                    <Search className="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
                    <Input
                      placeholder="�"�?�Tหา�-รั�zย�Oสิ�Tหรือรหัส�<ี�?รียล..."
                      className="h-10 rounded-full bg-white/90 pl-10 text-sm"
                      value={historySearch}
                      onChange={(e) => setHistorySearch(e.target.value)}
                    />
                    {historySearch && (
                      <button
                        onClick={() => setHistorySearch("")}
                        className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground"
                        aria-label="Clear history search"
                      >
                        <X className="h-3 w-3" />
                      </button>
                    )}
                  </div>
                  <div className="w-full">
                    <Select value={historyStatus} onValueChange={(value) => setHistoryStatus(value as typeof historyStatus)}>
                      <SelectTrigger className="h-10 rounded-full bg-white/90">
                        <SelectValue placeholder="�-ุกส�-า�Tะ" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">�-ุกส�-า�Tะ</SelectItem>
                        <SelectItem value="Active">กำลั�?�f�S�?�?า�T</SelectItem>
                        <SelectItem value="Completed">�"ื�Tแล�?ว</SelectItem>
                        <SelectItem value="Pending">รอ�"ำ�?�Tิ�Tการ</SelectItem>
                        <SelectItem value="Rejected">�-ูก�>ฏิ�?ส�~</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="flex flex-wrap items-center gap-2 text-xs text-muted-foreground lg:justify-end">
                    <Badge variant="secondary" className="rounded-full px-3 py-1">
                      �z�s {historyResults.toLocaleString()} รายการ
                    </Badge>
                    {historySearch && (
                      <Badge variant="secondary" className="rounded-full px-3 py-1">
                        �"ำ�"�?�Tหา: {historySearch}
                      </Badge>
                    )}
                  </div>
                </div>
              </div>              <div className="flex-1 overflow-y-auto pr-2">
                <div className="hidden md:grid grid-cols-[minmax(240px,1.6fr)_minmax(140px,0.7fr)_minmax(140px,0.7fr)_minmax(180px,0.8fr)] gap-3 px-2 pb-2 text-[11px] font-semibold uppercase tracking-wide text-muted-foreground">
                  <span>Asset</span>
                  <span>Borrowed</span>
                  <span>Returned</span>
                  <span className="text-right">Status</span>
                </div>
                {isTransLoading ? (
                  <div className="space-y-3">
                    <Skeleton className="h-24 w-full rounded-2xl" />
                    <Skeleton className="h-24 w-full rounded-2xl" />
                    <Skeleton className="h-24 w-full rounded-2xl" />
                  </div>
                ) : filteredTransactions.length > 0 ? (
                  <div className="space-y-3 pb-4">
                    {filteredTransactions.map((tx) => {
                      const assetName = tx.product_serials?.products?.name || "-";
                      const serialCode = tx.product_serials?.serial_code || "-";
                      const assetImage = tx.product_serials?.products?.image_url;
                      const isReturned = !!tx.return_date || tx.status === "Completed";
                      const canReturn = tx.status === "Active" && !tx.return_date;

                      return (
                        <div
                          key={tx.id}
                          className="group rounded-2xl border border-border/60 bg-white p-3 shadow-sm transition hover:-translate-y-0.5 hover:border-orange-200 hover:shadow-md focus-within:ring-2 focus-within:ring-orange-200 sm:p-4"
                        >
                          <div className="grid gap-3 md:grid-cols-[minmax(240px,1.6fr)_minmax(140px,0.7fr)_minmax(140px,0.7fr)_minmax(180px,0.8fr)] md:items-center">
                            <div className="flex items-center gap-3 min-w-0">
                              <button
                                type="button"
                                onClick={() => openImagePreview(assetImage, assetName)}
                                className={cn(
                                  "relative h-16 w-16 shrink-0 overflow-hidden rounded-xl border bg-muted/40 shadow-sm transition",
                                  assetImage && "hover:shadow-md",
                                )}
                                aria-label="View asset image"
                              >
                                {assetImage ? (
                                  <>
                                    <img
                                      src={assetImage}
                                      alt={assetName}
                                      className="h-full w-full object-cover transition duration-300 group-hover:scale-105"
                                    />
                                    <span className="absolute inset-0 bg-black/0 transition group-hover:bg-black/20" />
                                    <span className="absolute bottom-1 right-1 flex h-6 w-6 items-center justify-center rounded-full bg-white/85 text-slate-700 shadow-sm">
                                      <ZoomIn className="h-3.5 w-3.5" />
                                    </span>
                                  </>
                                ) : (
                                  <div className="flex h-full w-full items-center justify-center text-muted-foreground">
                                    <Package className="h-5 w-5" />
                                  </div>
                                )}
                              </button>
                              <div className="min-w-0 space-y-1">
                                <p className="truncate text-sm font-semibold text-foreground">{assetName}</p>
                                <div className="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                                  <span className="rounded-full bg-slate-100 px-2 py-0.5">Asset Code</span>
                                  <span className="font-mono">{serialCode}</span>
                                </div>
                              </div>
                            </div>

                            <div className="flex items-start gap-2 text-xs text-muted-foreground md:flex-col md:items-start">
                              <span className="md:hidden text-[11px] uppercase tracking-wide text-muted-foreground">Borrowed</span>
                              <span className="text-sm font-semibold text-foreground">
                                {formatDate(tx.borrow_date)}
                              </span>
                            </div>

                            <div className="flex items-start gap-2 text-xs text-muted-foreground md:flex-col md:items-start">
                              <span className="md:hidden text-[11px] uppercase tracking-wide text-muted-foreground">Returned</span>
                              <span
                                className={cn(
                                  "text-sm font-semibold",
                                  tx.return_date ? "text-emerald-600" : "text-muted-foreground",
                                )}
                              >
                                {tx.return_date ? formatDate(tx.return_date) : "-"}
                              </span>
                            </div>

                            <div className="flex flex-wrap items-center gap-2 md:justify-end">
                              <Badge
                                className={cn(
                                  "rounded-full px-3 py-1 text-xs font-semibold",
                                  isReturned
                                    ? "bg-emerald-100 text-emerald-700"
                                    : "bg-amber-100 text-amber-700",
                                )}
                              >
                                {isReturned ? "Returned" : "Borrowed"}
                              </Badge>
                              <StatusBadge status={tx.status} className="text-xs px-3 py-1" />
                              {canReturn ? (
                                <Button
                                  size="sm"
                                  className="h-8 gap-2 rounded-full bg-amber-500 text-white hover:bg-amber-600"
                                  onClick={() => setReturnDialog({ open: true, tx })}
                                >
                                  <CheckCircle2 className="h-4 w-4" />
                                  Mark Returned
                                </Button>
                              ) : (
                                <Badge variant="secondary" className="rounded-full px-3 py-1 text-xs">
                                  {isReturned ? "�"ื�Tแล�?ว" : "รอ�"ำ�?�Tิ�Tการ"}
                                </Badge>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <div className="flex flex-col items-center justify-center rounded-2xl border border-dashed border-border/60 bg-muted/20 py-12 text-muted-foreground">
                    <Package className="mb-2 h-12 w-12 opacity-20" />
                    <p>{hasHistoryFilters ? "�"ม�^�z�sรายการ�-ี�^�.ร�?กั�sการ�"�?�Tหา" : "�"ม�^�z�s�>ระวั�.ิการยืมอุ�>กร�"�O"}</p>
                    {hasHistoryFilters && (
                      <Button
                        variant="link"
                        onClick={() => {
                          setHistorySearch("");
                          setHistoryStatus("all");
                        }}
                      >
                        ล�?า�?�.ัวกรอ�?
                      </Button>
                    )}
                  </div>
                )}
              </div>
            </div>

          </DialogContent>
        </Dialog>

        <Dialog open={imagePreview.open} onOpenChange={(open) => setImagePreview((prev) => ({ ...prev, open }))}>
          <DialogContent className="sm:max-w-[900px] max-h-[90vh] overflow-hidden p-0 bg-black/90 border-none">
            <div className="relative flex h-full max-h-[85vh] w-full items-center justify-center p-4">
              <img
                src={imagePreview.url}
                alt={imagePreview.name}
                className="max-h-[75vh] w-auto max-w-full rounded-xl object-contain"
              />
              <Button
                variant="ghost"
                size="icon"
                className="absolute right-4 top-4 h-9 w-9 rounded-full bg-white/90 text-slate-700 hover:bg-white"
                onClick={() => setImagePreview({ open: false, url: "", name: "" })}
                aria-label="Close image preview"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </DialogContent>
        </Dialog>

        <ReturnDialog
          open={returnDialog.open}
          onOpenChange={(open) => setReturnDialog((prev) => ({ ...prev, open }))}
          tx={returnDialog.tx}
          onConfirm={handleReturnConfirm}
          isPending={returnTransaction.isPending}
        />

        {/* Import CSV Dialog */}
        <ImportEmployeeDialog 
          isOpen={isImportDialogOpen} 
          onClose={() => setIsImportDialogOpen(false)} 
        />

      </div>
      </div>
    </MainLayout>
  );
}



